---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostItem from '../../../components/PostItem.astro';
import TagFilter from '../../../components/TagFilter.astro';
import Footer from '../../../components/Footer.astro';

export async function getStaticPaths() {
  const posts = await getCollection('writing');
  const publishedPosts = posts.filter(p => !p.data.draft);

  // Get unique tags
  const uniqueTags = [...new Set(publishedPosts.map(p => p.data.tag))];

  return uniqueTags.map(tag => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const allPosts = (await getCollection('writing'))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const filteredPosts = allPosts.filter(p => p.data.tag === tag);

// Build tag counts from all posts
const tagCounts = allPosts.reduce((acc, post) => {
  acc[post.data.tag] = (acc[post.data.tag] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const tags = Object.entries(tagCounts)
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout title={`${tag} — Writing — Sai Soundararajan`}>
  <div class="container">
    <a href="/" class="back-link">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back
    </a>

    <section class="section">
      <div class="section-header">
        <h1 class="page-title">Writing</h1>
      </div>

      <TagFilter tags={tags} activeTag={tag} />

      <div class="posts">
        {filteredPosts.map(post => (
          <PostItem
            title={post.data.title}
            date={post.data.date}
            tag={post.data.tag}
            slug={post.slug}
          />
        ))}
      </div>
    </section>

    <Footer />
  </div>
</BaseLayout>
