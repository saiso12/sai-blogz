---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Profile from '../components/Profile.astro';
import Nav from '../components/Nav.astro';
import Currently from '../components/Currently.astro';
import ProjectCard from '../components/ProjectCard.astro';
import PostItem from '../components/PostItem.astro';
import TagFilter from '../components/TagFilter.astro';
import Footer from '../components/Footer.astro';

const projects = (await getCollection('projects'))
  .sort((a, b) => a.data.order - b.data.order);

const allPosts = (await getCollection('writing'))
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const posts = allPosts.slice(0, 5);

// Build tag counts
const tagCounts = allPosts.reduce((acc, post) => {
  acc[post.data.tag] = (acc[post.data.tag] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const tags = Object.entries(tagCounts)
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout title="Sai Soundararajan — Builder">
  <div class="container">
    <Profile
      name="Sai Soundararajan"
      initials="SS"
      role="Platform Engineering Lead"
      company="SpotOn"
      github="https://github.com/saiso12"
    />

    <Nav currentPath="/" />

    <Currently items={[
      { label: "Reading", value: "Staff Engineer", link: "https://staffeng.com/book" },
      { label: "Learning", value: "MCP Servers" },
      { label: "Location", value: "Bay Area" }
    ]} />

    <section class="section">
      <div class="section-header">
        <h2 class="section-title">Building</h2>
      </div>
      <div class="projects-grid">
        {projects.map(project => (
          <ProjectCard
            title={project.data.title}
            description={project.data.description}
            status={project.data.status}
            url={project.data.url}
            meta={project.data.meta}
            slug={project.slug}
          />
        ))}
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2 class="section-title">Writing</h2>
      </div>
      <TagFilter tags={tags} />
      <div class="posts">
        {posts.map(post => (
          <PostItem
            title={post.data.title}
            date={post.data.date}
            tag={post.data.tag}
            slug={post.slug}
          />
        ))}
      </div>
      {allPosts.length > 5 && (
        <a href="/writing" class="view-all-link">View all posts →</a>
      )}
    </section>

    <Footer />
  </div>
</BaseLayout>
